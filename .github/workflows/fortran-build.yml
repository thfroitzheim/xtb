name: CI
on: [push, pull_request]
env:
   BUILD_DIR: _build
jobs:
   gcc-meson-build:
      runs-on: ${{ matrix.os }}
      strategy:
         fail-fast: false
         matrix:
            os: [ubuntu-latest]
            version: [12, 13, 14]
            include:
               - os: ubuntu-22.04
                 version: 10
               - os: ubuntu-22.04
                 version: 11
               - os: ubuntu-24.04-arm
                 version: 14
               - os: macos-15-intel
                 version: 15
               - os: macos-latest
                 version: 14
               - os: macos-latest
                 version: 15
      steps:
         - name: Checkout code
           uses: actions/checkout@v4
         - name: Setup Python
           uses: actions/setup-python@v5
           with:
            python-version: 3.x
         - name: Install OpenBLAS (macOS)
           if: ${{ contains(matrix.os, 'macos') }}
           run: |
            brew install openblas
            echo "PKG_CONFIG_PATH=/usr/local/opt/openblas/lib/pkgconfig" >> $GITHUB_ENV
            echo "LDFLAGS=-L/opt/homebrew/opt/openblas/lib" >> $GITHUB_ENV
            echo "CPPFLAGS=-I/opt/homebrew/opt/openblas/include" >> $GITHUB_ENV
         - name: Install OpenBLAS (ubuntu-latest)
           if: ${{ matrix.os == 'ubuntu-latest' || contains(matrix.os, 'ubuntu-24.04') }}
           run: |
            sudo apt-get install libopenblas-dev
         - name: Install meson
           run: pip install meson==1.7.0 ninja
         - name: Configure build
           run: >-
            meson setup ${{ env.BUILD_DIR }} --buildtype=debug --warnlevel=0 -Db_coverage=true ${{ env.MESON_ARGS }}
           env:
            FC: gfortran-${{ matrix.version }}
            CC: gcc-${{ matrix.version }}
            MESON_ARGS: ${{ contains(matrix.os, 'macos') && '-Dlapack=openblas' || '-Dlapack=netlib' }}
         - name: Build project
           run: meson compile -C ${{ env.BUILD_DIR }}
         - name: Run unit tests
           run: meson test -C ${{ env.BUILD_DIR }} --print-errorlogs --no-rebuild -t 120 --suite xtb
           env:
            OMP_NUM_THREADS: 2,1
         - name: Upload coverage report
           run: bash <(curl -s https://codecov.io/bash)
   gcc-cmake-build:
      runs-on: ${{ matrix.os }}
      strategy:
         fail-fast: false
         matrix:
            os: [ubuntu-latest, ubuntu-24.04-arm]
            fc: [gfortran-14]
            cc: [gcc-14]
            build: [Release, Debug]
      steps:
         - name: Checkout code
           uses: actions/checkout@v4
         - name: Setup Python
           uses: actions/setup-python@v5
           with:
            python-version: 3.x
         - name: Install OpenBLAS (ubuntu-latest)
           if: ${{ matrix.os == 'ubuntu-latest' || contains(matrix.os, 'ubuntu-24.04') }}
           run: |
            sudo apt-get install libopenblas-dev
         - name: Install CMake
           run: pip install ninja cmake
         - name: Configure build
           run: cmake -B ${{ env.BUILD_DIR }} -G Ninja -DCMAKE_BUILD_TYPE=${{ matrix.build }}
           env:
            FC: ${{ matrix.fc }}
            CC: ${{ matrix.cc }}
         - name: Build project
           run: cmake --build ${{ env.BUILD_DIR }}
         - name: Run unit tests
           run: ctest --parallel --output-on-failure -R 'xtb/*' -E 'tblite/gfn1-xtb'
           working-directory: ${{ env.BUILD_DIR }}
           env:
            OMP_NUM_THREADS: 2,1
   xtb-lightweight-meson-build:
      runs-on: ${{ matrix.os }}
      strategy:
         fail-fast: false
         matrix:
            os: [ubuntu-latest]
            fc: [gfortran-14]
            cc: [gcc-14]
      steps:
         - name: Checkout code
           uses: actions/checkout@v4
         - name: Setup Python
           uses: actions/setup-python@v5
           with:
            python-version: 3.10.x
         - name: Install OpenBLAS (ubuntu-latest)
           if: ${{ matrix.os == 'ubuntu-latest' || contains(matrix.os, 'ubuntu-24.04') }}
           run: |
            sudo apt-get install libopenblas-dev
         - name: Install meson
           run: pip3 install meson==0.62.0 ninja cmake
         - name: Configure build
           run: >-
            meson setup ${{ env.BUILD_DIR }} --buildtype=debug --warnlevel=0 ${{ env.MESON_ARGS }}
           env:
            FC: ${{ matrix.fc }}
            CC: ${{ matrix.cc }}
            MESON_ARGS: ${{ '-Dlapack=netlib -Dtblite=disabled -Dcpcmx=disabled' }}
         - name: Build project
           run: meson compile -C ${{ env.BUILD_DIR }}
         - name: Run unit tests
           run: meson test -C ${{ env.BUILD_DIR }} --print-errorlogs --no-rebuild -t 120 --suite xtb
           env:
            OMP_NUM_THREADS: 2,1
   xtb-lightweight-cmake-build:
      runs-on: ${{ matrix.os }}
      strategy:
         fail-fast: false
         matrix:
            os: [ubuntu-latest]
            fc: [gfortran-14]
            cc: [gcc-14]
      steps:
         - name: Checkout code
           uses: actions/checkout@v4
         - name: Setup Python
           uses: actions/setup-python@v5
           with:
            python-version: 3.x
         - name: Install OpenBLAS (ubuntu-latest)
           if: ${{ matrix.os == 'ubuntu-latest' || contains(matrix.os, 'ubuntu-24.04') }}
           run: |
            sudo apt-get install libopenblas-dev
         - name: Install CMake
           run: pip3 install ninja cmake
         - name: Configure build
           run: cmake -B ${{ env.BUILD_DIR }} -DWITH_CPCMX=false -DWITH_TBLITE=false -G Ninja
           env:
            FC: ${{ matrix.fc }}
            CC: ${{ matrix.cc }}
         - name: Build project
           run: cmake --build ${{ env.BUILD_DIR }}
         - name: Run unit tests
           run: ctest --parallel --output-on-failure -R 'xtb/*'
           working-directory: ${{ env.BUILD_DIR }}
           env:
            OMP_NUM_THREADS: 2,1
   # Test native MinGW Windows build
   mingw-meson-build:
      runs-on: windows-latest
      strategy:
         fail-fast: false
         matrix:
            include: [{msystem: MINGW64, arch: x86_64,}
               # { msystem: MINGW32, arch: i686   }
            ]
      defaults:
         run:
            shell: msys2 {0}
      steps:
         - name: Checkout code
           uses: actions/checkout@v4
         - name: Setup MSYS2 toolchain
           uses: msys2/setup-msys2@v2
           with:
            msystem: ${{ matrix.msystem }}
            update: false
            install: >-
               git mingw-w64-${{ matrix.arch }}-gcc-fortran mingw-w64-${{ matrix.arch }}-openblas mingw-w64-${{ matrix.arch }}-lapack mingw-w64-${{ matrix.arch }}-python mingw-w64-${{ matrix.arch }}-python-pip mingw-w64-${{ matrix.arch }}-meson mingw-w64-${{ matrix.arch }}-ninja
         - name: Configure build
           run: meson setup ${{ env.BUILD_DIR }} -Dlapack=netlib --warnlevel=0
           env:
            FC: gfortran
            CC: gcc
         - name: Build project
           run: meson compile -C ${{ env.BUILD_DIR }}
         - name: Run unit tests
           run: meson test -C ${{ env.BUILD_DIR }} --print-errorlogs --no-rebuild -t 120 --suite xtb
           env:
            OMP_NUM_THREADS: 1
   intel-meson-build:
      runs-on: ${{ matrix.os }}
      strategy:
         fail-fast: false
         matrix:
            os: [ubuntu-latest]
            fc: [ifort]
            cc: [icc]
      env:
         FC: ${{ matrix.fc }}
         CC: ${{ matrix.cc }}
         APT_PACKAGES: >-
            intel-oneapi-compiler-fortran-2022.1.0 intel-oneapi-compiler-dpcpp-cpp-and-cpp-classic-2022.1.0 intel-oneapi-mkl-2022.1.0 intel-oneapi-mkl-devel-2022.1.0 asciidoctor
      steps:
         - name: Checkout code
           uses: actions/checkout@v4
         - name: Setup Python
           uses: actions/setup-python@v5
           with:
            python-version: 3.x
         - run: pip3 install meson==1.7.0 ninja --user
         - name: Add Intel repository
           if: contains(matrix.os, 'ubuntu')
           run: |
            wget https://apt.repos.intel.com/intel-gpg-keys/GPG-PUB-KEY-INTEL-SW-PRODUCTS-2023.PUB
            sudo apt-key add GPG-PUB-KEY-INTEL-SW-PRODUCTS-2023.PUB
            rm GPG-PUB-KEY-INTEL-SW-PRODUCTS-2023.PUB
            echo "deb https://apt.repos.intel.com/oneapi all main" | sudo tee /etc/apt/sources.list.d/oneAPI.list
            sudo apt-get update
         - name: Install Intel oneAPI compiler
           if: contains(matrix.os, 'ubuntu')
           run: |
            sudo apt-get install ${APT_PACKAGES}
            source /opt/intel/oneapi/setvars.sh
            printenv >> $GITHUB_ENV
         - name: Configure meson build
           run: >-
            meson setup ${{ env.BUILD_DIR }} --prefix=/ --libdir=lib -Dfortran_link_args="-lifcoremt -static" -Ddefault_library=static -Dlapack=mkl
         - name: Build project
           run: ninja -C ${{ env.BUILD_DIR }}
         - name: Run unit tests
           run: >-
            meson test -C ${{ env.BUILD_DIR }} --print-errorlogs --num-processes 1 --no-rebuild --suite xtb -t 120
           env:
            OMP_NUM_THREADS: 2,1
         - name: Install package
           run: |
            meson install -C ${{ env.BUILD_DIR }} --no-rebuild
            tar cJvf xtb-bleed.tar.xz xtb-bleed
           env:
            DESTDIR: ${{ env.PWD }}/xtb-bleed
         - name: Upload binary
           if: github.event_name == 'push'
           uses: actions/upload-artifact@v4
           with:
            name: xtb-bleed.tar.xz
            path: xtb-bleed.tar.xz
   intel-ifx-cmake-build:
      runs-on: ${{ matrix.os }}
      strategy:
         fail-fast: false
         matrix:
            os: [ubuntu-latest]
            build: [Release]
            toolchain:
              - {compiler: intel, version: '2024.1'}
#               - {compiler: intel, version: '2025.0'} SegFault in disp/ncoord.f90 near 'do concurrent(tx = -rep_cn(1):rep_cn(1), &'
#               - {compiler: intel, version: '2025.1'} # Worked fine as of Jul 2, 2025; commit d3f212ba83287290efafee6580670d02d7b2f49d
              - {compiler: intel, version: '2025.2'}
      env:
         APT_PACKAGES: >-
            intel-oneapi-mkl-${{ matrix.toolchain.version }} intel-oneapi-mkl-devel-${{ matrix.toolchain.version }}
      steps:
         - name: Checkout code
           uses: actions/checkout@v4
         - name: Setup Fortran
           uses: fortran-lang/setup-fortran@v1
           with:
            compiler: ${{ matrix.toolchain.compiler }}
            version: ${{ matrix.toolchain.version }}
         - name: Setup Python
           uses: actions/setup-python@v5
           with:
            python-version: 3.x
         - run: pip3 install cmake ninja --user
         - name: Install Intel MKL
           if: contains(matrix.os, 'ubuntu')
           run: |
            sudo apt-get install ${APT_PACKAGES}
            source /opt/intel/oneapi/setvars.sh --force
            printenv >> $GITHUB_ENV
         - name: Configure cmake build
           run: >-
            cmake -B ${{ env.BUILD_DIR }} -G Ninja -DCMAKE_BUILD_TYPE=${{ matrix.build }} -DCMAKE_C_COMPILER=icx -DCMAKE_Fortran_COMPILER=ifx -DBLA_VENDOR=Intel10_64lp -DWITH_TBLITE=false 
         - name: Build project
           run: ninja -C ${{ env.BUILD_DIR }}
         - name: Run unit tests
           run: ctest --parallel --output-on-failure -R 'xtb/*'
           working-directory: ${{ env.BUILD_DIR }}
           env:
            OMP_NUM_THREADS: 2,1
   intel-ifx-meson-build:
      runs-on: ${{ matrix.os }}
      strategy:
         fail-fast: false
         matrix:
            os: [ubuntu-latest]
            toolchain:
              - {compiler: intel, version: '2024.1'}
#               - {compiler: intel, version: '2025.0'} SegFault in disp/ncoord.f90 near 'do concurrent(tx = -rep_cn(1):rep_cn(1), &'
              - {compiler: intel, version: '2025.1'}
      env:
         APT_PACKAGES: >-
            intel-oneapi-mkl-${{ matrix.toolchain.version }} intel-oneapi-mkl-devel-${{ matrix.toolchain.version }}
      steps:
         - name: Checkout code
           uses: actions/checkout@v4
         - name: Setup Fortran
           uses: fortran-lang/setup-fortran@v1
           with:
            compiler: ${{ matrix.toolchain.compiler }}
            version: ${{ matrix.toolchain.version }}
         - name: Setup Python
           uses: actions/setup-python@v5
           with:
            python-version: 3.x
         - run: pip3 install meson==1.7.0 ninja --user
         - name: Install Intel MKL
           if: contains(matrix.os, 'ubuntu')
           run: |
            sudo apt-get install ${APT_PACKAGES}
            source /opt/intel/oneapi/setvars.sh --force
            printenv >> $GITHUB_ENV
         - name: Configure meson build
           run: >-
            CC=${{ env.CC }} FC=${{ env.FC }} meson setup ${{ env.BUILD_DIR }} --prefix=/ --libdir=lib -Dfortran_link_args="-lifcoremt -static" -Ddefault_library=static -Dlapack=mkl -Dtblite=disabled
         - name: Build project
           run: ninja -C ${{ env.BUILD_DIR }}
         - name: Run unit tests
           run: >-
            meson test -C ${{ env.BUILD_DIR }} --print-errorlogs --num-processes 1 --no-rebuild --suite xtb -t 120
           env:
            OMP_NUM_THREADS: 2,1
   # mingw-meson-static-build:
   #    runs-on: windows-latest
   #    strategy:
   #       fail-fast: false
   #       matrix:
   #          include: [{msystem: MINGW64, arch: x86_64,}
   #             # { msystem: MINGW32, arch: i686   }
   #          ]
   #    defaults:
   #       run:
   #          shell: msys2 {0}
   #    steps:
   #       - name: Checkout code
   #         uses: actions/checkout@v4
   #       - name: Setup MSYS2 toolchain
   #         uses: msys2/setup-msys2@v2
   #         with:
   #          msystem: ${{ matrix.msystem }}
   #          update: false
   #          install: >-
   #             git mingw-w64-${{ matrix.arch }}-gcc-fortran mingw-w64-${{ matrix.arch }}-openblas mingw-w64-${{ matrix.arch }}-lapack mingw-w64-${{ matrix.arch }}-python mingw-w64-${{ matrix.arch }}-python-pip mingw-w64-${{ matrix.arch }}-meson mingw-w64-${{ matrix.arch }}-ninja
   #       - name: Configure build
   #         run: meson setup ${{ env.BUILD_DIR }} -Ddefault_library=static -Dlapack=netlib --warnlevel=0
   #         env:
   #           FC: gfortran
   #           CC: gcc
   #       - name: Build project
   #         run: meson compile -C ${{ env.BUILD_DIR }}
   #       - name: Run unit tests
   #         run: meson test -C ${{ env.BUILD_DIR }} --print-errorlogs --no-rebuild -t 120 --suite xtb
   #         env:
   #          OMP_NUM_THREADS: 1
   #       - name: Install package
   #         run: |
   #          DESTDIR="$PWD/install" meson install -C ${{ env.BUILD_DIR }} --no-rebuild
   #          bsdtar -acf xtb-windows-static.zip -C install .
   #       - name: Upload artifact
   #         uses: actions/upload-artifact@v4
   #         with:
   #          name: xtb-windows-static
   #          path: xtb-windows-static.zip

   # mingw-meson-static-build:
   #   runs-on: windows-latest
   #   strategy:
   #     fail-fast: false
   #     matrix:
   #       include:
   #         - { msystem: MINGW64, arch: x86_64 }
   #   defaults:
   #     run:
   #       shell: msys2 {0}
   #   steps:
   #     - name: Checkout code
   #       uses: actions/checkout@v4
   
   #     - name: Setup MSYS2 toolchain
   #       uses: msys2/setup-msys2@v2
   #       with:
   #         msystem: ${{ matrix.msystem }}
   #         update: false
   #         install: >-
   #           git
   #           mingw-w64-${{ matrix.arch }}-gcc-fortran
   #           mingw-w64-${{ matrix.arch }}-openblas
   #           mingw-w64-${{ matrix.arch }}-lapack
   #           mingw-w64-${{ matrix.arch }}-python
   #           mingw-w64-${{ matrix.arch }}-python-pip
   #           mingw-w64-${{ matrix.arch }}-meson
   #           mingw-w64-${{ matrix.arch }}-ninja
   #           mingw-w64-${{ matrix.arch }}-binutils

   #     # NOTE: disable LTO to avoid GCC 15 LTO ICE, and link quadmath explicitly
   #     - name: Configure build (static)
   #       run: >
   #         meson setup ${{ env.BUILD_DIR }}
   #         -Ddefault_library=static
   #         -Dlapack=netlib
   #         -Db_lto=false
   #         --warnlevel=0
   #       env:
   #         CC: gcc
   #         FC: gfortran
   #         # Prefer static libs when resolving with pkg-config
   #         PKG_CONFIG_ALL_STATIC: "1"
   #         # Compile flags
   #         CFLAGS: "-fno-strict-aliasing"
   #         FFLAGS: "-fno-strict-aliasing"
   #         # Link fully static; add quadmath to satisfy libgfortran when linked from C
   #         LDFLAGS: "-static -static-libgcc -static-libgfortran -static-libstdc++ -Wl,--as-needed -lquadmath"

         
   #     - name: Build project
   #       run: meson compile -C ${{ env.BUILD_DIR }}
   #       #   # build the xtb unit tester explicitly so --no-rebuild works
   #       #   meson compile -C ${{ env.BUILD_DIR }} test/unit/tester.exe || true

   #     - name: Run unit tests
   #       run: meson test -C ${{ env.BUILD_DIR }} --print-errorlogs --no-rebuild -t 120 --suite xtb
   #       env:
   #         OMP_NUM_THREADS: 2
         
   #     - name: Install package
   #       run: |
   #         DESTDIR="$PWD/install" meson install -C ${{ env.BUILD_DIR }} --no-rebuild
   #         # Strip binaries to shrink the artifact
   #         if [ -f "install/mingw64/bin/xtb.exe" ]; then x86_64-w64-mingw32-strip install/mingw64/bin/xtb.exe || true; fi
   #         bsdtar -acf xtb-windows-static.zip -C install .

   #     # Ensure tools we use are available
   #     - name: Install helper tools
   #       shell: msys2 {0}
   #       run: |
   #         set -euo pipefail
   #         pacman -S --noconfirm --needed mingw-w64-x86_64-ntldd zip
                
   #     # Locate xtb.exe regardless of layout
   #     - name: Locate xtb.exe
   #       shell: msys2 {0}
   #       run: |
   #         set -euo pipefail
   #         shopt -s globstar nullglob
   #         candidates=(
   #           "install/mingw64/bin/xtb.exe"
   #           "_build/**/xtb.exe"
   #           "**/xtb.exe"
   #           "**/bin/xtb.exe"
   #         )
   #         EXE=""
   #         for p in "${candidates[@]}"; do
   #           for q in $p; do
   #             if [ -f "$q" ]; then EXE="$q"; break 2; fi
   #           done
   #         done
   #         if [ -z "$EXE" ]; then
   #           echo "::error::xtb.exe not found in expected locations." ; exit 1
   #         fi
   #         echo "Found: $EXE"
   #         echo "EXE=$EXE" >> "$GITHUB_ENV"
                
   #     # --- Replace the "Bundle DLLs next to the binary" step with this ---
   #     - name: Bundle only direct DLL dependencies
   #       shell: msys2 {0}
   #       run: |
   #         set -euo pipefail
   #         mkdir -p bundle/bin
   #         cp "$EXE" bundle/bin/
       
   #         # Collect direct imports from the EXE import table
   #         mapfile -t direct < <(objdump -p "$EXE" | sed -n 's/ \+DLL Name: //p')
       
   #         # Windows/system DLLs to ignore (case-insensitive match)
   #         ignore_re='^(kernel32\.dll|msvcrt\.dll|ucrtbase\.dll|vcruntime140(_1)?\.dll|api-ms-win-.*|k32.*\.dll|advapi32\.dll|ws2_32\.dll|sechost\.dll|user32\.dll|ole32\.dll)$'
       
   #         # Resolve each direct import to a path with ntldd and copy it
   #         for name in "${direct[@]}"; do
   #           low="$(printf '%s' "$name" | tr '[:upper:]' '[:lower:]')"
   #           if echo "$low" | grep -Eq "$ignore_re"; then
   #             continue
   #           fi
   #           # Find the resolved path of this exact direct import
   #           path="$(ntldd "$EXE" | awk -v want="$low" 'BEGIN{IGNORECASE=1} $1==want {print $3; exit}')"
   #           if [ -n "${path:-}" ] && [ "$path" != "not" ] && [ -f "$path" ]; then
   #             echo "Bundling $(basename "$path")"
   #             cp -n "$path" bundle/bin/
   #           else
   #             echo "::warning::Could not resolve direct import $name"
   #           fi
   #         done

   #     # --- Optional but useful: print whether OpenMP is present ---
   #     - name: Report OpenMP runtime (detected)
   #       shell: msys2 {0}
   #       run: |
   #         set -euo pipefail
   #         need="$(objdump -p "$EXE" | sed -n 's/ \+DLL Name: //p' | tr '[:upper:]' '[:lower:]' | grep -E 'libgomp|libiomp5md' || true)"
   #         if [ -n "$need" ]; then
   #           echo "OpenMP runtime detected in import table: $need"
   #         else
   #           echo "No OpenMP runtime DLL in import table (OpenMP disabled or linked statically)."
   #         fi
             
   #     # --- Replace the "Verify bundled dependencies" step with this ---
   #     - name: Verify bundled direct dependencies only
   #       shell: msys2 {0}
   #       run: |
   #          set -euo pipefail
   #          pushd bundle/bin >/dev/null
                  
   #          # Ensure empty globs don't expand to the literal pattern
   #          shopt -s nullglob
                  
   #          ignore_re='^(kernel32\.dll|msvcrt\.dll|ucrtbase\.dll|vcruntime140(_1)?\.dll|api-ms-win-.*|k32.*\.dll|advapi32\.dll|ws2_32\.dll|sechost\.dll|user32\.dll|ole32\.dll)$'
                  
   #          # Build allowlist of direct (non-system) imports
   #          mapfile -t allowed < <(
   #            objdump -p xtb.exe | sed -n 's/ \+DLL Name: //p' \
   #            | tr '[:upper:]' '[:lower:]' | grep -Ev "$ignore_re"
   #          )
                  
   #          missing=0
                  
   #          # 1) Every allowed DLL must exist in the bundle
   #          for name in "${allowed[@]}"; do
   #            if ! ls -1 | tr '[:upper:]' '[:lower:]' | grep -qx "$name"; then
   #              echo "::error::Missing direct dependency $name in bundle/bin"
   #              missing=1
   #            fi
   #          done
                  
   #          # 2) No extra DLLs present
   #          for f in *.dll; do
   #            lf="$(printf '%s' "$f" | tr '[:upper:]' '[:lower:]')"
   #            if ! printf "%s\n" "${allowed[@]}" | grep -qx "$lf"; then
   #              echo "::error::Extra DLL bundled that is not a direct import: $f"
   #              missing=1
   #            fi
   #          done
                  
   #          popd >/dev/null
   #          [ $missing -eq 0 ]
                
   #     # Produce the final zip
   #     - name: Create distributable zip
   #       shell: msys2 {0}
   #       run: |
   #         set -euo pipefail
   #         mkdir -p artifacts
   #         (cd bundle && zip -r ../artifacts/xtb-win64.zip .)

       
   #     - name: Upload artifact (bundled DLL build)
   #       uses: actions/upload-artifact@v4
   #       with:
   #          name: xtb-win64-bundle
   #          path: artifacts/xtb-win64.zip
   #          if-no-files-found: error
   #          overwrite: true

   mingw-meson-static-build:
     runs-on: windows-latest
     strategy:
       fail-fast: false
       matrix:
         include:
           - { msystem: MINGW64, arch: x86_64 }
     defaults:
       run:
         shell: msys2 {0}
 
     steps:
       - name: Checkout code
         uses: actions/checkout@v4
 
       - name: Setup MSYS2 toolchain
         uses: msys2/setup-msys2@v2
         with:
           msystem: ${{ matrix.msystem }}
           update: false
           install: >-
             git
             mingw-w64-${{ matrix.arch }}-gcc-fortran
             mingw-w64-${{ matrix.arch }}-openblas
             mingw-w64-${{ matrix.arch }}-lapack
             mingw-w64-${{ matrix.arch }}-python
             mingw-w64-${{ matrix.arch }}-python-pip
             mingw-w64-${{ matrix.arch }}-meson
             mingw-w64-${{ matrix.arch }}-ninja
             mingw-w64-${{ matrix.arch }}-binutils
             mingw-w64-${{ matrix.arch }}-ntldd
             zip
 
       # Force a flat install root like on Linux: /bin, /lib, /share under DESTDIR
       - name: Configure build (static)
         run: >
           meson setup ${{ env.BUILD_DIR }}
           --prefix=${{ env.INSTALL_PREFIX }}
           --libdir=lib
           -Ddefault_library=static
           -Dlapack=netlib
           -Db_lto=false
           --warnlevel=0
         env:
           CC: gcc
           FC: gfortran
           INSTALL_PREFIX: ${{ env.PWD }}/xtb-bleed-windows
           PKG_CONFIG_ALL_STATIC: "1"
           CFLAGS: "-fno-strict-aliasing"
           FFLAGS: "-fno-strict-aliasing"
           # Fully static toolchain libs; BLAS/LAPACK remain DLLs if linked that way
           LDFLAGS: "-static -static-libgcc -static-libgfortran -static-libstdc++ -Wl,--as-needed -lquadmath"

       - name: Build project
         run: meson compile -C ${{ env.BUILD_DIR }}
 
       - name: Run unit tests
         run: meson test -C ${{ env.BUILD_DIR }} --print-errorlogs --no-rebuild -t 120 --suite xtb
         env:
           OMP_NUM_THREADS: 2
 
       - name: Install package
         run: |
           meson install -C ${{ env.BUILD_DIR }} --no-rebuild
         env:
           DESTDIR: ${{ env.PWD }}/xtb-bleed-windows

       # Copy ONLY direct BLAS/LAPACK if xtb.exe actually imports them
       - name: Add BLAS/LAPACK DLLs if referenced
         run: |
           set -euo pipefail
           EXE="${{ env.INSTALL_PREFIX }}/bin/xtb.exe"
           if [ ! -f "$EXE" ]; then
             echo "::error::$EXE not found after install"; exit 1
           fi
           mapfile -t imports < <(objdump -p "$EXE" | sed -n 's/ \+DLL Name: //p' | tr '[:upper:]' '[:lower:]')
           for want in libblas.dll liblapack.dll; do
             if printf "%s\n" "${imports[@]}" | grep -qx "$want"; then
               path="$(ntldd "$EXE" | awk -v want="$want" 'BEGIN{IGNORECASE=1} $1==want {print $3; exit}')"
               if [ -n "${path:-}" ] && [ -f "$path" ]; then
                 echo "Bundling $want from $path"
                 cp -n "$path" "${{ env.INSTALL_PREFIX }}/bin/"
               else
                 echo "::warning::$want referenced but could not be resolved with ntldd"
               fi
             else
               echo "$want not referenced by xtb.exe; skipping."
             fi
           done

       - name: Create distributable zip
         run: |
           set -euo pipefail
           zip -r xtb-bleed-windows.zip ${{ env.PWD }}/xtb-bleed-windows 

       - name: Upload binary
         if: github.event_name == 'push'
         uses: actions/upload-artifact@v4
         with:
           name: xtb-bleed-windows.zip
           path: xtb-bleed-windows.zip


   # Inspired from https://github.com/endless-sky/endless-sky
   continuous-delivery:
      if: github.event_name == 'push'
      runs-on: ubuntu-latest
      needs:
         - intel-meson-build
      env:
         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
         RELEASE_TAG: bleed
         OUTPUT_INTEL: xtb-bleed.tar.xz
      steps:
         - uses: actions/checkout@v4
         - name: Install github-release
           run: |
            go install github.com/github-release/github-release@latest
            echo "GOPATH=$(go env GOPATH)" >> $GITHUB_ENV
            echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
         - name: Set environment variables
           run: |
            echo "GITHUB_USER=$( echo ${{ github.repository }} | cut -d/ -f1 )" >> $GITHUB_ENV
            echo "GITHUB_REPO=$( echo ${{ github.repository }} | cut -d/ -f2 )" >> $GITHUB_ENV
         - name: Move/Create continuous tag
           run: |
            git tag --force ${{ env.RELEASE_TAG }} ${{ github.sha }}
            git push --tags --force
         - name: Get Time
           run: echo "TIME=$(date -u '+%Y/%m/%d, %H:%M')" >> $GITHUB_ENV
         - name: Check continuous release status
           run: |
            if ! github-release info -t ${{ env.RELEASE_TAG }} > /dev/null 2>&1; then
               echo "RELEASE_COMMAND=release" >> $GITHUB_ENV
            else
               echo "RELEASE_COMMAND=edit" >> $GITHUB_ENV
            fi
         - name: Setup continuous release
           run: >-
            github-release ${{ env.RELEASE_COMMAND }} --tag ${{ env.RELEASE_TAG }} --name "Bleeding edge version" --description "$DESCRIPTION" --pre-release
           env:
            DESCRIPTION: |
               Created on ${{ env.TIME }} UTC by @${{ github.actor }} with commit ${{ github.sha }}.
               This is an automated distribution of the latest `xtb` version. This version is only minimally tested and may be unstable or even crash. Use with caution!
               https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
         - name: Download Artifacts
           uses: actions/download-artifact@v4.1.7
           with:
            path: ${{ github.workspace }} # This will download all files
         - name: Create SHA256 checksum
           run: |
            cd ${{ env.OUTPUT_INTEL }}
            sha256sum ${{ env.OUTPUT_INTEL }} > sha256.txt
         - name: Add ${{ env.OUTPUT_INTEL }} to release tag
           run: >-
            github-release upload --tag ${{ env.RELEASE_TAG }} --replace --name ${{ env.OUTPUT_INTEL }} --file ${{ env.OUTPUT_INTEL }}/${{ env.OUTPUT_INTEL }}
         - name: Add SHA256 checksums to release tag
           run: >-
            github-release upload --tag ${{ env.RELEASE_TAG }} --replace --name sha256.txt --file ${{ env.OUTPUT_INTEL }}/sha256.txt
